name: build-and-test

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm (frontend)
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Clean environment (frontend)
        working-directory: ./frontend
        run: |
          rm -rf node_modules
          npm cache clean --force

      - name: Install dependencies (frontend)
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci --legacy-peer-deps
          else
            npm install --legacy-peer-deps
          fi

      - name: Run tests (frontend)
        working-directory: ./frontend
        run: |
          npm test -- --watchAll=false --ci > test-results.log 2>&1 || true

      - name: Save and commit test log to ci-logs branch
        if: always()
        env:
          REPO: ${{ github.repository }}
          RUN_NUMBER: ${{ github.run_number }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "Preparing run-specific logs (no top-level ci-logs folder)..."

          # write logs to a run-specific folder (avoid creating a top-level 'ci-logs' path)
          LOG_DIR="logs/ci/${RUN_NUMBER}"
          mkdir -p "$LOG_DIR"

          # copy only the test result into the run-specific folder
          if [ -f ./frontend/test-results.log ]; then
            cp ./frontend/test-results.log "$LOG_DIR/test-log-${RUN_NUMBER}.txt"
          else
            echo "no frontend/test-results.log found"
          fi

          # configure git user
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # use token so push is allowed
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"

          # fetch remote ci-logs ref if it exists (safe)
          git fetch origin +refs/heads/ci-logs:refs/remotes/origin/ci-logs || true

          # create a temp branch (based on current workspace) to stage only the logs
          git checkout -B temp-commit-logs

          # add only the run-specific logs (force in case of gitignore)
          git add --force "$LOG_DIR" || true

          # commit only if there are staged changes
          if git diff --staged --quiet; then
            echo "No log changes to commit"
          else
            git commit -m "Add CI logs for run ${RUN_NUMBER}"
            # push explicitly to refs/heads/ci-logs to avoid name ambiguity
            git push origin HEAD:refs/heads/ci-logs --force-with-lease
          fi

          # restore previous branch (best-effort) dummy update
          git checkout - || true

      - name: Build the app (frontend)
        working-directory: ./frontend
        run: npm run build --if-present