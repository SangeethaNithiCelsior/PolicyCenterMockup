name: build-and-test

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm (frontend)
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Clean environment (frontend)
        working-directory: ./frontend
        run: |
          rm -rf node_modules
          npm cache clean --force

      - name: Install dependencies (frontend)
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci --legacy-peer-deps
          else
            npm install --legacy-peer-deps
          fi

      - name: Run tests (frontend)
        working-directory: ./frontend
        run: |
          npm test -- --watchAll=false --ci > test-results.log 2>&1 || true

      - name: Save and commit test log to ci-logs branch
        if: always()
        env:
          REPO: ${{ github.repository }}
          RUN_NUMBER: ${{ github.run_number }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # prepare folder
          mkdir -p ci-logs
          cp frontend/test-results.log ci-logs/test-log-${RUN_NUMBER}.txt || echo "no test log"

          # configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # create or update ci-logs branch locally
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${REPO}.git

          # fetch ci-logs if exists
          if git ls-remote --exit-code --heads origin ci-logs; then
            git fetch origin ci-logs
            git checkout ci-logs
          else
            git checkout --orphan ci-logs
            git rm -rf . || true
          fi

          # copy new logs into repo root (or subfolder)
          mkdir -p ci-logs
          cp -f ../ci-logs/* ci-logs/ 2>/dev/null || true
          # move from workspace copy
          cp -f ci-logs/test-log-${RUN_NUMBER}.txt ci-logs/ || true

          git add ci-logs || true
          # commit only if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add test log for run ${RUN_NUMBER}" || true
            git push origin ci-logs --set-upstream
          fi

      - name: Build the app (frontend)
        working-directory: ./frontend
        run: npm run build --if-present
