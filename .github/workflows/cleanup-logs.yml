name: cleanup-logs

# Scheduled cleanup - runs weekly on Sundays at 2 AM UTC
# Can also be triggered manually
on:
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC
  workflow_dispatch:
    inputs:
      keep:
        description: 'Number of log runs to keep'
        required: false
        default: '5'
        type: string

# Prevent overlapping cleanup runs
concurrency:
  group: cleanup-logs
  cancel-in-progress: false

permissions:
  contents: write

env:
  KEEP: ${{ github.event.inputs.keep || '5' }}  # Use manual input or default to 5

jobs:
  cleanup-logs:
    name: Cleanup ${{ matrix.branch }} branch
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false  # Continue cleaning other branch even if one fails
      matrix:
        branch: [ci-logs, deploy-logs]
    
    steps:
      - name: Checkout ${{ matrix.branch }} branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 1
          persist-credentials: true

      - name: Cleanup old logs (keep last ${{ env.KEEP }})
        shell: bash
        env:
          KEEP: ${{ env.KEEP }}
          LOG_DIR: logs/ci
          BRANCH: ${{ matrix.branch }}
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"

          echo "üßπ Cleaning up $BRANCH branch..."
          
          if [ ! -d "$LOG_DIR" ]; then
            echo "‚ÑπÔ∏è  No $LOG_DIR found on $BRANCH branch; nothing to delete."
            exit 0
          fi

          cd "$LOG_DIR" || exit 0
          shopt -s nullglob
          mapfile -t dirs < <(for d in */; do printf '%s\n' "${d%/}"; done | sort -n)

          total=${#dirs[@]}
          keep=${KEEP:-5}
          echo "üìä Found $total log folders; will keep last $keep by numeric name."

          if (( total > keep )); then
            remove_count=$(( total - keep ))
            echo "üóëÔ∏è  Deleting $remove_count older folder(s)..."
            removed=()
            for (( i=0; i<remove_count; i++ )); do
              target="${dirs[i]}"
              echo "  ‚ûú Removing: $target"
              rm -rf -- "$target"
              removed+=("$target")
            done

            # prepare git commit
            cd "$GITHUB_WORKSPACE"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # fetch latest to reduce push conflicts
            git fetch origin "$BRANCH":"$BRANCH" || git fetch origin
            
            git add -A -- "$LOG_DIR"
            if ! git diff --cached --quiet; then
              git commit -m "ci: cleanup older logs on $BRANCH - keep last $keep"
              
              # retry push with exponential backoff
              max_attempts=3
              for attempt in $(seq 1 $max_attempts); do
                if git push origin "HEAD:$BRANCH"; then
                  echo "‚úÖ Pushed cleanup commit to $BRANCH."
                  break
                else
                  if [ $attempt -lt $max_attempts ]; then
                    wait_time=$((attempt * 2))
                    echo "‚ö†Ô∏è  Push failed, attempt $attempt/$max_attempts. Retrying in ${wait_time}s..."
                    sleep $wait_time
                    git fetch origin "$BRANCH":"$BRANCH" || git fetch origin
                    git rebase "origin/$BRANCH" || {
                      echo "‚ùå Rebase failed, aborting and retrying..."
                      git rebase --abort || true
                    }
                  else
                    echo "‚ùå Failed to push after $max_attempts attempts."
                    exit 1
                  fi
                fi
              done
            else
              echo "‚ÑπÔ∏è  No changes to commit after cleanup."
            fi

            # summary
            if [ ${#removed[@]} -gt 0 ]; then
              echo ""
              echo "üìã Summary for $BRANCH:"
              echo "   Removed ${#removed[@]} folder(s): ${removed[*]}"
              echo "   Kept last $keep folder(s)"
            fi
          else
            echo "‚úÖ Nothing to delete (have $total <= keep $keep)."
          fi
