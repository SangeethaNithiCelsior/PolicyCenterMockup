name: cleanup-logs

# Trigger on push to main
on:
  push:
    branches:
      - main
  workflow_dispatch: {}

# Prevent overlapping cleanup runs
concurrency:
  group: cleanup-logs
  cancel-in-progress: false

permissions:
  contents: write

env:
  KEEP: 5          # universal keep value for both jobs; change here to adjust

jobs:
  cleanup-ci-logs:
    name: Cleanup ci-logs branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ci-logs branch
        uses: actions/checkout@v4
        with:
          ref: ci-logs
          fetch-depth: 0
          persist-credentials: true

      - name: Cleanup old logs (keep last ${{ env.KEEP }})
        shell: bash
        env:
          KEEP: ${{ env.KEEP }}
          LOG_DIR: logs/ci   # adjust if your ci logs live elsewhere
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"

          if [ ! -d "$LOG_DIR" ]; then
            echo "No $LOG_DIR found on this branch; nothing to delete."
            exit 0
          fi

          cd "$LOG_DIR" || exit 0
          shopt -s nullglob
          mapfile -t dirs < <(for d in */; do printf '%s\n' "${d%/}"; done | sort -n)

          total=${#dirs[@]}
          keep=${KEEP:-5}
          echo "Found $total folders; will keep last $keep by numeric name."

          if (( total > keep )); then
            remove_count=$(( total - keep ))
            echo "Deleting $remove_count older folder(s)..."
            removed=()
            for (( i=0; i<remove_count; i++ )); do
              target="${dirs[i]}"
              echo "Removing: $target"
              rm -rf -- "$target"
              removed+=("$target")
            done

            # prepare git commit
            cd "$GITHUB_WORKSPACE"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # fetch latest and rebase to reduce push conflicts
            git fetch origin
            git rebase "origin/ci-logs" || true

            git add -A -- "$LOG_DIR"
            if ! git diff --cached --quiet; then
              git commit -m "ci: cleanup older logs - keep last $keep"
              # retry push a few times in case of race
              for i in 1 2 3; do
                if git push origin HEAD:ci-logs; then
                  echo "Pushed cleanup commit to ci-logs."
                  break
                else
                  echo "Push failed, attempt $i. Fetching latest and rebasing..."
                  git fetch origin
                  git rebase "origin/ci-logs" || true
                  sleep $((i * 2))
                fi
              done
            else
              echo "No changes to commit after cleanup."
            fi

            # summary of removed dirs
            if [ ${#removed[@]} -gt 0 ]; then
              echo "Removed folders: ${removed[*]}"
            fi
          else
            echo "Nothing to delete (have $total <= keep $keep)."
          fi

  cleanup-deploy-logs:
    name: Cleanup deploy-logs branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout deploy-logs branch
        uses: actions/checkout@v4
        with:
          ref: deploy-logs
          fetch-depth: 0
          persist-credentials: true

      - name: Cleanup old logs (keep last ${{ env.KEEP }})
        shell: bash
        env:
          KEEP: ${{ env.KEEP }}
          LOG_DIR: logs/ci   # adjust if your deploy logs live in a different folder
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"

          if [ ! -d "$LOG_DIR" ]; then
            echo "No $LOG_DIR found on this branch; nothing to delete."
            exit 0
          fi

          cd "$LOG_DIR" || exit 0
          shopt -s nullglob
          mapfile -t dirs < <(for d in */; do printf '%s\n' "${d%/}"; done | sort -n)

          total=${#dirs[@]}
          keep=${KEEP:-5}
          echo "Found $total folders; will keep last $keep by numeric name."

          if (( total > keep )); then
            remove_count=$(( total - keep ))
            echo "Deleting $remove_count older folder(s)..."
            removed=()
            for (( i=0; i<remove_count; i++ )); do
              target="${dirs[i]}"
              echo "Removing: $target"
              rm -rf -- "$target"
              removed+=("$target")
            done

            # prepare git commit
            cd "$GITHUB_WORKSPACE"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # fetch latest and rebase to reduce push conflicts
            git fetch origin
            git rebase "origin/deploy-logs" || true

            git add -A -- "$LOG_DIR"
            if ! git diff --cached --quiet; then
              git commit -m "ci: cleanup older logs - keep last $keep"
              # retry push a few times in case of race
              for i in 1 2 3; do
                if git push origin HEAD:deploy-logs; then
                  echo "Pushed cleanup commit to deploy-logs."
                  break
                else
                  echo "Push failed, attempt $i. Fetching latest and rebasing..."
                  git fetch origin
                  git rebase "origin/deploy-logs" || true
                  sleep $((i * 2))
                fi
              done
            else
              echo "No changes to commit after cleanup."
            fi

            # summary of removed dirs
            if [ ${#removed[@]} -gt 0 ]; then
              echo "Removed folders: ${removed[*]}"
            fi
          else
            echo "Nothing to delete (have $total <= keep $keep)."
          fi
